import json

from django.contrib.postgres import forms, lookups
from django.contrib.postgres.fields.array import ArrayField
from django.core import exceptions
from django.db.models import Field, TextField, Transform
<<<<<<< HEAD
from django.utils import six
from django.utils.encoding import force_text
from django.utils.translation import ugettext_lazy as _
=======
from django.utils.translation import gettext_lazy as _

from .mixins import CheckFieldDefaultMixin
>>>>>>> a49b7d6bd2068c3888052b51a1a4869cb0918bdc

__all__ = ['HStoreField']


<<<<<<< HEAD
class HStoreField(Field):
=======
class HStoreField(CheckFieldDefaultMixin, Field):
>>>>>>> a49b7d6bd2068c3888052b51a1a4869cb0918bdc
    empty_strings_allowed = False
    description = _('Map of strings to strings/nulls')
    default_error_messages = {
        'not_a_string': _('The value of "%(key)s" is not a string or null.'),
    }
<<<<<<< HEAD
=======
    _default_hint = ('dict', '{}')
>>>>>>> a49b7d6bd2068c3888052b51a1a4869cb0918bdc

    def db_type(self, connection):
        return 'hstore'

    def get_transform(self, name):
<<<<<<< HEAD
        transform = super(HStoreField, self).get_transform(name)
=======
        transform = super().get_transform(name)
>>>>>>> a49b7d6bd2068c3888052b51a1a4869cb0918bdc
        if transform:
            return transform
        return KeyTransformFactory(name)

    def validate(self, value, model_instance):
<<<<<<< HEAD
        super(HStoreField, self).validate(value, model_instance)
        for key, val in value.items():
            if not isinstance(val, six.string_types) and val is not None:
=======
        super().validate(value, model_instance)
        for key, val in value.items():
            if not isinstance(val, str) and val is not None:
>>>>>>> a49b7d6bd2068c3888052b51a1a4869cb0918bdc
                raise exceptions.ValidationError(
                    self.error_messages['not_a_string'],
                    code='not_a_string',
                    params={'key': key},
                )

    def to_python(self, value):
<<<<<<< HEAD
        if isinstance(value, six.string_types):
=======
        if isinstance(value, str):
>>>>>>> a49b7d6bd2068c3888052b51a1a4869cb0918bdc
            value = json.loads(value)
        return value

    def value_to_string(self, obj):
        return json.dumps(self.value_from_object(obj))

    def formfield(self, **kwargs):
<<<<<<< HEAD
        defaults = {
            'form_class': forms.HStoreField,
        }
        defaults.update(kwargs)
        return super(HStoreField, self).formfield(**defaults)

    def get_prep_value(self, value):
        value = super(HStoreField, self).get_prep_value(value)
=======
        return super().formfield(**{
            'form_class': forms.HStoreField,
            **kwargs,
        })

    def get_prep_value(self, value):
        value = super().get_prep_value(value)
>>>>>>> a49b7d6bd2068c3888052b51a1a4869cb0918bdc

        if isinstance(value, dict):
            prep_value = {}
            for key, val in value.items():
<<<<<<< HEAD
                key = force_text(key)
                if val is not None:
                    val = force_text(val)
=======
                key = str(key)
                if val is not None:
                    val = str(val)
>>>>>>> a49b7d6bd2068c3888052b51a1a4869cb0918bdc
                prep_value[key] = val
            value = prep_value

        if isinstance(value, list):
<<<<<<< HEAD
            value = [force_text(item) for item in value]
=======
            value = [str(item) for item in value]
>>>>>>> a49b7d6bd2068c3888052b51a1a4869cb0918bdc

        return value


HStoreField.register_lookup(lookups.DataContains)
HStoreField.register_lookup(lookups.ContainedBy)
HStoreField.register_lookup(lookups.HasKey)
HStoreField.register_lookup(lookups.HasKeys)
HStoreField.register_lookup(lookups.HasAnyKeys)


class KeyTransform(Transform):
    output_field = TextField()

    def __init__(self, key_name, *args, **kwargs):
<<<<<<< HEAD
        super(KeyTransform, self).__init__(*args, **kwargs)
=======
        super().__init__(*args, **kwargs)
>>>>>>> a49b7d6bd2068c3888052b51a1a4869cb0918bdc
        self.key_name = key_name

    def as_sql(self, compiler, connection):
        lhs, params = compiler.compile(self.lhs)
<<<<<<< HEAD
        return "(%s -> '%s')" % (lhs, self.key_name), params


class KeyTransformFactory(object):
=======
        return '(%s -> %%s)' % lhs, tuple(params) + (self.key_name,)


class KeyTransformFactory:
>>>>>>> a49b7d6bd2068c3888052b51a1a4869cb0918bdc

    def __init__(self, key_name):
        self.key_name = key_name

    def __call__(self, *args, **kwargs):
        return KeyTransform(self.key_name, *args, **kwargs)


@HStoreField.register_lookup
class KeysTransform(Transform):
    lookup_name = 'keys'
    function = 'akeys'
    output_field = ArrayField(TextField())


@HStoreField.register_lookup
class ValuesTransform(Transform):
    lookup_name = 'values'
    function = 'avals'
    output_field = ArrayField(TextField())

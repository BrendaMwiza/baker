import json

from django import forms
<<<<<<< HEAD
from django.utils import six
from django.utils.translation import ugettext_lazy as _
=======
from django.utils.translation import gettext_lazy as _
>>>>>>> a49b7d6bd2068c3888052b51a1a4869cb0918bdc

__all__ = ['JSONField']


<<<<<<< HEAD
class InvalidJSONInput(six.text_type):
    pass


class JSONString(six.text_type):
=======
class InvalidJSONInput(str):
    pass


class JSONString(str):
>>>>>>> a49b7d6bd2068c3888052b51a1a4869cb0918bdc
    pass


class JSONField(forms.CharField):
    default_error_messages = {
        'invalid': _("'%(value)s' value must be valid JSON."),
    }
    widget = forms.Textarea

    def to_python(self, value):
        if self.disabled:
            return value
        if value in self.empty_values:
            return None
        elif isinstance(value, (list, dict, int, float, JSONString)):
            return value
        try:
            converted = json.loads(value)
<<<<<<< HEAD
        except ValueError:
=======
        except json.JSONDecodeError:
>>>>>>> a49b7d6bd2068c3888052b51a1a4869cb0918bdc
            raise forms.ValidationError(
                self.error_messages['invalid'],
                code='invalid',
                params={'value': value},
            )
<<<<<<< HEAD
        if isinstance(converted, six.text_type):
=======
        if isinstance(converted, str):
>>>>>>> a49b7d6bd2068c3888052b51a1a4869cb0918bdc
            return JSONString(converted)
        else:
            return converted

    def bound_data(self, data, initial):
        if self.disabled:
            return initial
        try:
            return json.loads(data)
<<<<<<< HEAD
        except ValueError:
=======
        except json.JSONDecodeError:
>>>>>>> a49b7d6bd2068c3888052b51a1a4869cb0918bdc
            return InvalidJSONInput(data)

    def prepare_value(self, value):
        if isinstance(value, InvalidJSONInput):
            return value
        return json.dumps(value)
<<<<<<< HEAD
=======

    def has_changed(self, initial, data):
        if super().has_changed(initial, data):
            return True
        # For purposes of seeing whether something has changed, True isn't the
        # same as 1 and the order of keys doesn't matter.
        data = self.to_python(data)
        return json.dumps(initial, sort_keys=True) != json.dumps(data, sort_keys=True)
>>>>>>> a49b7d6bd2068c3888052b51a1a4869cb0918bdc

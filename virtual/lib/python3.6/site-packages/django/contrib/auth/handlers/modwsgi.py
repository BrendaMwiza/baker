from django import db
from django.contrib import auth
<<<<<<< HEAD
from django.utils.encoding import force_bytes
=======
>>>>>>> a49b7d6bd2068c3888052b51a1a4869cb0918bdc

UserModel = auth.get_user_model()


def check_password(environ, username, password):
    """
<<<<<<< HEAD
    Authenticates against Django's auth database
=======
    Authenticate against Django's auth database.
>>>>>>> a49b7d6bd2068c3888052b51a1a4869cb0918bdc

    mod_wsgi docs specify None, True, False as return value depending
    on whether the user exists and authenticates.
    """
<<<<<<< HEAD

    # db connection state is managed similarly to the wsgi handler
    # as mod_wsgi may call these functions outside of a request/response cycle
    db.reset_queries()

=======
    # db connection state is managed similarly to the wsgi handler
    # as mod_wsgi may call these functions outside of a request/response cycle
    db.reset_queries()
>>>>>>> a49b7d6bd2068c3888052b51a1a4869cb0918bdc
    try:
        try:
            user = UserModel._default_manager.get_by_natural_key(username)
        except UserModel.DoesNotExist:
            return None
        if not user.is_active:
            return None
        return user.check_password(password)
    finally:
        db.close_old_connections()


def groups_for_user(environ, username):
    """
<<<<<<< HEAD
    Authorizes a user based on groups
    """

    db.reset_queries()

=======
    Authorize a user based on groups
    """
    db.reset_queries()
>>>>>>> a49b7d6bd2068c3888052b51a1a4869cb0918bdc
    try:
        try:
            user = UserModel._default_manager.get_by_natural_key(username)
        except UserModel.DoesNotExist:
            return []
        if not user.is_active:
            return []
<<<<<<< HEAD
        return [force_bytes(group.name) for group in user.groups.all()]
=======
        return [group.name.encode() for group in user.groups.all()]
>>>>>>> a49b7d6bd2068c3888052b51a1a4869cb0918bdc
    finally:
        db.close_old_connections()
